<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Smart Parking Assistant | Real-Time</title>
  <style>
    :root { 
        --primary: #00d1b2; 
        --danger: #ff3860;
        --bg: #0b1118; 
        --card-bg: #161d27;
        --text: #e7eaf3;
        font-family: 'Inter', system-ui, -apple-system, sans-serif; 
    }
    body { margin: 0; background: var(--bg); color: var(--text); display: flex; justify-content: center; height: 100vh; overflow: hidden; }
    .wrap { width: 100%; max-width: 1200px; display: flex; gap: 20px; padding: 20px; box-sizing: border-box; }
    
    /* Panel Izquierdo: Chat */
    .chat-section { flex: 1; display: flex; flex-direction: column; background: var(--card-bg); border-radius: 20px; border: 1px solid rgba(255,255,255,0.1); overflow: hidden; }
    #chatWindow { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 12px; scroll-behavior: smooth; }
    .msg { max-width: 80%; padding: 12px 16px; border-radius: 15px; font-size: 14px; line-height: 1.5; }
    .msg-user { align-self: flex-end; background: var(--primary); color: #003e35; font-weight: 600; border-bottom-right-radius: 2px; }
    .msg-ai { align-self: flex-start; background: rgba(255,255,255,0.08); border-bottom-left-radius: 2px; }

    /* Panel Derecho: Mapa e Info */
    .map-section { width: 420px; background: var(--card-bg); border-radius: 20px; padding: 20px; border: 1px solid rgba(255,255,255,0.1); display: flex; flex-direction: column; }
    .parking-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; margin: 20px 0; }
    .spot { 
        height: 70px; border-radius: 10px; border: 2px solid rgba(255,255,255,0.1); 
        display: flex; flex-direction: column; align-items: center; justify-content: center; 
        font-size: 11px; font-weight: bold; transition: all 0.4s ease; 
    }
    .spot.free { border-color: var(--primary); background: rgba(0, 209, 178, 0.1); color: var(--primary); box-shadow: inset 0 0 10px rgba(0,209,178,0.1); }
    .spot.occupied { border-color: var(--danger); background: rgba(255, 56, 96, 0.1); color: var(--danger); }
    .led { width: 8px; height: 8px; border-radius: 50%; margin-bottom: 5px; }
    .free .led { background: var(--primary); box-shadow: 0 0 10px var(--primary); }
    .occupied .led { background: var(--danger); }

    /* Controles */
    .input-area { padding: 15px; background: rgba(0,0,0,0.2); border-top: 1px solid rgba(255,255,255,0.1); }
    .input-group { display: flex; gap: 8px; }
    input { flex: 1; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.15); border-radius: 10px; color: white; padding: 12px; outline: none; }
    .btn { background: var(--primary); color: #003e35; border: none; padding: 0 20px; border-radius: 10px; font-weight: 700; cursor: pointer; }
    .btn:disabled { opacity: 0.5; }

    .status-bar { display: flex; justify-content: space-between; font-size: 12px; margin-top: auto; padding-top: 15px; border-top: 1px solid rgba(255,255,255,0.1); }
    .loading { font-size: 12px; color: var(--primary); margin-bottom: 10px; display: none; }
  </style>
</head>
<body>

<div class="wrap">
    <div class="chat-section">
        <div style="padding: 15px 20px; border-bottom: 1px solid rgba(255,255,255,0.1)">
            <h2 style="margin:0; font-size: 18px;">Smart Parking Assistant</h2>
            <small id="apiStatus" style="color: #666;">Conectando a API Gateway...</small>
        </div>
        
        <div id="chatWindow">
            <div class="msg msg-ai">Â¡Bienvenido! Soy tu asistente de aparcamiento en tiempo real. Â¿Buscas un sitio ahora mismo?</div>
        </div>

        <div class="input-area">
            <div id="loader" class="loading">Consultando sensores y Athena...</div>
            <div class="input-group">
                <input id="userInput" placeholder="Pregunta algo (ej. Â¿DÃ³nde hay sitio libre?)...">
                <button class="btn" id="sendBtn">Enviar</button>
            </div>
        </div>
    </div>

    <div class="map-section">
        <h3 style="margin-top:0">Estado de Planta 0</h3>
        <div class="parking-grid" id="mapGrid">
            </div>
        <div class="status-bar">
            <span>ðŸŸ¢ <span id="freeNum">0</span> Disponibles</span>
            <span>ðŸ”´ <span id="occNum">0</span> Ocupados</span>
        </div>
        <button class="btn" onclick="updateMap()" style="margin-top:15px; padding: 10px; width: 100%; background: transparent; border: 1px solid var(--primary); color: var(--primary);">Refrescar Mapa</button>
    </div>
</div>

<script>
    const API_URL = "https://pmv073dn7k.execute-api.us-east-1.amazonaws.com/prod/traffic";
    const chatWindow = document.getElementById("chatWindow");
    const loader = document.getElementById("loader");
    const mapGrid = document.getElementById("mapGrid");

    async function callApi(params) {
        const url = new URL(API_URL);
        Object.entries(params).forEach(([k, v]) => url.searchParams.set(k, v));
        try {
            const response = await fetch(url, {
                method: "GET",
                headers: { "Accept": "application/json" }
            });
            if (!response.ok) throw new Error(`HTTP Error: ${response.status}`);
            const data = await response.json();
            return typeof data.body === 'string' ? JSON.parse(data.body) : data;
        } catch (err) {
            console.error("Error en API:", err);
            throw err;
        }
    }

    // --- LÃ“GICA DEL MAPA REAL ---
    async function updateMap() {
        loader.style.display = "block";
        try {
            // Pedimos los Ãºltimos estados. 
            // La Lambda usarÃ¡ las columnas: sensor_id y status
            const data = await callApi({ mode: 'filters', limit: 20 });
            
            // Si la API devuelve filas, las pintamos
            if (data.result && data.result.rows) {
                renderMap(data.result.rows);
            } else {
                addMessage("El mapa no recibiÃ³ datos de la base de datos.", 'ai');
            }
        } catch (e) {
            addMessage("Error al refrescar el mapa desde Athena.", 'ai');
        } finally {
            loader.style.display = "none";
        }
    }

    function renderMap(rows) {
    mapGrid.innerHTML = "";
    let free = 0;
    let occupied = 0;

    if (rows.length === 0) {
        mapGrid.innerHTML = "<div style='grid-column: 1/-1; text-align:center;'>Sin datos recientes</div>";
        return;
    }

    // 1. Quedarnos con el Ãºltimo estado de cada sensor
    const latestSensorsMap = {};
    rows.forEach(row => {
        if (!latestSensorsMap[row.sensor_id]) {
            latestSensorsMap[row.sensor_id] = row;
        }
    });

    // 2. Convertir a Array y ORDENAR por sensor_id
    const sortedSensors = Object.values(latestSensorsMap).sort((a, b) => {
        // Esto ordena alfabÃ©ticamente (A-1 antes que A-2) o numÃ©ricamente
        return a.sensor_id.localeCompare(b.sensor_id, undefined, {numeric: true, sensitivity: 'base'});
    });

    // 3. Pintar en orden
    sortedSensors.forEach(sensor => {
        const isFree = sensor.status.toLowerCase() === 'free' || sensor.status === '1';
        if (isFree) free++; else occupied++;

        const spot = document.createElement("div");
        spot.className = `spot ${isFree ? 'free' : 'occupied'}`;
        spot.innerHTML = `
            <div class="led"></div>
            <span>${sensor.sensor_id}</span>
            <small style="font-size:8px; opacity:0.7">${sensor.event_time || ''}</small>
        `;
        mapGrid.appendChild(spot);
    });

    document.getElementById("freeNum").textContent = free;
    document.getElementById("occNum").textContent = occupied;
}

    async function handleChat() {
        const text = document.getElementById("userInput").value;
        if (!text) return;

        addMessage(text, 'user');
        document.getElementById("userInput").value = "";
        loader.style.display = "block";

        try {
            const data = await callApi({ mode: 'llm', prompt: text });
            addMessage(data.output || "No tengo respuesta en este momento.");
            
            // Si la respuesta del LLM incluyÃ³ nuevos datos, refrescamos mapa
            if (data.result && data.result.rows) {
                renderMap(data.result.rows);
            } else {
                updateMap(); 
            }
        } catch (e) {
            addMessage("Error en la conexiÃ³n con el asistente.", 'ai');
        } finally {
            loader.style.display = "none";
        }
    }

    function addMessage(msg, type = 'ai') {
        const div = document.createElement("div");
        div.className = `msg msg-${type}`;
        div.textContent = msg;
        chatWindow.appendChild(div);
        chatWindow.scrollTop = chatWindow.scrollHeight;
    }

    document.getElementById("sendBtn").onclick = handleChat;
    document.getElementById("userInput").onkeypress = (e) => { if(e.key === 'Enter') handleChat(); };

    window.onload = () => {
        updateMap();
        document.getElementById("apiStatus").textContent = "API Conectada";
        document.getElementById("apiStatus").style.color = "var(--primary)";
    };
</script>

</body>
</html>
