<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Smart Parking Assistant | Real-Time</title>
  <link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@500;700&family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
  <style>
    :root { 
        --primary: #00d1b2; 
        --primary-dim: rgba(0, 209, 178, 0.15);
        --danger: #ff3860;
        --danger-dim: rgba(255, 56, 96, 0.15);
        --bg: #0b1118; 
        --card-bg: #161d27;
        --lane: #1a2230;
        --text: #e7eaf3;
        --muted: #4a5568;
    }

    * { box-sizing: border-box; }
    body { 
        margin: 0; background: var(--bg); color: var(--text); 
        display: flex; justify-content: center; height: 100vh; overflow: hidden; 
        font-family: 'Inter', system-ui, sans-serif;
    }
    .wrap { width: 100%; max-width: 1260px; display: flex; gap: 20px; padding: 20px; }
    
    /* ── Chat Panel ── */
    .chat-section { 
        flex: 1; display: flex; flex-direction: column; 
        background: var(--card-bg); border-radius: 20px; 
        border: 1px solid rgba(255,255,255,0.08); overflow: hidden; 
    }
    .chat-header { padding: 16px 20px; border-bottom: 1px solid rgba(255,255,255,0.08); }
    .chat-header h2 { margin: 0; font-family: 'Rajdhani', sans-serif; font-size: 20px; letter-spacing: 1px; }
    #apiStatus { font-size: 11px; color: #666; }
    #chatWindow { 
        flex: 1; overflow-y: auto; padding: 20px; 
        display: flex; flex-direction: column; gap: 12px; scroll-behavior: smooth; 
    }
    .msg { max-width: 82%; padding: 12px 16px; border-radius: 14px; font-size: 14px; line-height: 1.55; }
    .msg-user { align-self: flex-end; background: var(--primary); color: #003e35; font-weight: 600; border-bottom-right-radius: 3px; }
    .msg-ai { align-self: flex-start; background: rgba(255,255,255,0.07); border-bottom-left-radius: 3px; }
    .input-area { padding: 14px 16px; background: rgba(0,0,0,0.25); border-top: 1px solid rgba(255,255,255,0.08); }
    .input-group { display: flex; gap: 8px; }
    input { 
        flex: 1; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.12); 
        border-radius: 10px; color: white; padding: 11px 14px; outline: none; font-size: 14px;
        transition: border-color 0.2s;
    }
    input:focus { border-color: var(--primary); }
    .btn-send { 
        background: var(--primary); color: #003e35; border: none; 
        padding: 0 20px; border-radius: 10px; font-weight: 700; cursor: pointer; font-size: 14px;
        transition: opacity 0.2s;
    }
    .btn-send:disabled { opacity: 0.45; }
    .loading { font-size: 11px; color: var(--primary); margin-bottom: 8px; display: none; animation: pulse 1.2s infinite; }
    @keyframes pulse { 0%,100%{opacity:1} 50%{opacity:0.4} }

    /* ── Map Panel ── */
    .map-section { 
        width: 440px; background: var(--card-bg); border-radius: 20px; padding: 20px; 
        border: 1px solid rgba(255,255,255,0.08); display: flex; flex-direction: column; 
        overflow: hidden;
    }
    .map-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; }
    .map-header h3 { margin: 0; font-family: 'Rajdhani', sans-serif; font-size: 17px; letter-spacing: 0.5px; }
    .legend { display: flex; gap: 12px; font-size: 11px; }
    .legend-item { display: flex; align-items: center; gap: 5px; }
    .legend-dot { width: 8px; height: 8px; border-radius: 50%; }

    /* ── Parking Lot Visual ── */
    .parking-lot { 
        background: #0d1520; 
        border-radius: 14px; 
        padding: 14px 10px;
        border: 1px solid rgba(255,255,255,0.06);
        flex: 1;
        overflow-y: auto;
        position: relative;
    }
    
    /* Each "row" = a lane with spots on both sides */
    .parking-row { 
        display: flex; 
        gap: 0;
        margin-bottom: 6px;
        position: relative;
    }
    
    /* The driving lane in between */
    .lane { 
        flex: 0 0 36px; 
        background: var(--lane);
        margin: 0 4px;
        border-radius: 4px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 8px;
        color: rgba(255,255,255,0.15);
        letter-spacing: 1px;
        text-orientation: mixed;
        writing-mode: vertical-rl;
        font-family: 'Rajdhani', sans-serif;
        font-weight: 700;
        position: relative;
        overflow: hidden;
    }
    /* Dashed lane markings */
    .lane::after {
        content: '';
        position: absolute;
        left: 50%;
        top: 4px; bottom: 4px;
        width: 1px;
        background: repeating-linear-gradient(
            to bottom,
            rgba(255,255,255,0.18) 0px,
            rgba(255,255,255,0.18) 6px,
            transparent 6px,
            transparent 12px
        );
    }

    .spots-col { 
        flex: 1; 
        display: flex; 
        flex-direction: column; 
        gap: 5px; 
    }
    .spots-col.left { align-items: flex-end; }
    .spots-col.right { align-items: flex-start; }

    /* Individual parking spot — car-shaped */
    .spot {
        width: 100%;
        max-width: 130px;
        height: 46px;
        border-radius: 5px;
        border: 1.5px solid rgba(255,255,255,0.1);
        position: relative;
        display: flex; align-items: center; justify-content: flex-start;
        padding: 0 8px;
        gap: 8px;
        cursor: default;
        transition: all 0.35s ease;
        overflow: hidden;
    }
    .spot::before {
        /* Parking stripe lines */
        content: '';
        position: absolute;
        inset: 0;
        background: repeating-linear-gradient(
            90deg,
            transparent,
            transparent 14px,
            rgba(255,255,255,0.025) 14px,
            rgba(255,255,255,0.025) 15px
        );
    }

    .spot.free { 
        border-color: rgba(0, 209, 178, 0.45); 
        background: rgba(0, 209, 178, 0.05);
    }
    .spot.free:hover { 
        background: rgba(0, 209, 178, 0.12); 
        border-color: var(--primary);
        box-shadow: 0 0 14px rgba(0,209,178,0.2);
    }
    .spot.occupied { 
        border-color: rgba(255, 56, 96, 0.35); 
        background: rgba(255, 56, 96, 0.04);
    }

    /* Car silhouette inside occupied spot */
    .car-icon {
        position: absolute;
        right: 6px;
        top: 50%;
        transform: translateY(-50%);
        display: flex;
        align-items: center;
        justify-content: center;
        opacity: 0;
        transition: opacity 0.3s;
    }
    .spot.occupied .car-icon { opacity: 1; }
    .car-svg { width: 36px; height: 20px; }

    .spot-label { 
        font-family: 'Rajdhani', sans-serif; 
        font-size: 12px; font-weight: 700; 
        z-index: 1; letter-spacing: 0.5px; 
        flex-shrink: 0;
    }
    .spot.free .spot-label { color: var(--primary); }
    .spot.occupied .spot-label { color: var(--danger); }

    .spot-time { 
        font-size: 9px; color: rgba(255,255,255,0.3); 
        z-index: 1; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
        max-width: 60px;
    }

    /* Status bar */
    .status-bar { 
        display: flex; justify-content: space-between; align-items: center;
        font-size: 12px; margin-top: 14px; padding-top: 12px; 
        border-top: 1px solid rgba(255,255,255,0.08); 
    }
    .stat { display: flex; align-items: center; gap: 6px; }
    .stat-dot { width: 9px; height: 9px; border-radius: 50%; }
    .stat-dot.free { background: var(--primary); box-shadow: 0 0 8px var(--primary); }
    .stat-dot.occ { background: var(--danger); }
    .stat-num { font-family: 'Rajdhani', sans-serif; font-size: 18px; font-weight: 700; line-height: 1; }
    .stat-num.free { color: var(--primary); }
    .stat-num.occ { color: var(--danger); }

    .btn-refresh { 
        margin-top: 12px; padding: 9px; width: 100%; 
        background: transparent; border: 1px solid rgba(0,209,178,0.4); 
        color: var(--primary); border-radius: 10px; cursor: pointer; 
        font-family: 'Rajdhani', sans-serif; font-size: 13px; font-weight: 700; letter-spacing: 1px;
        transition: all 0.2s;
    }
    .btn-refresh:hover { background: rgba(0,209,178,0.08); border-color: var(--primary); }

    /* scrollbar */
    ::-webkit-scrollbar { width: 4px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.1); border-radius: 4px; }
  </style>
</head>
<body>

<div class="wrap">
    <!-- Chat -->
    <div class="chat-section">
        <div class="chat-header">
            <h2>⬡ Smart Parking Assistant</h2>
            <small id="apiStatus">Conectando a API Gateway...</small>
        </div>
        
        <div id="chatWindow">
            <div class="msg msg-ai">¡Bienvenido! Soy tu asistente de aparcamiento en tiempo real. ¿Buscas un sitio ahora mismo?</div>
        </div>

        <div class="input-area">
            <div id="loader" class="loading">⬡ Consultando sensores y Athena...</div>
            <div class="input-group">
                <input id="userInput" placeholder="Pregunta algo (ej. ¿Dónde hay sitio libre?)...">
                <button class="btn-send" id="sendBtn">Enviar</button>
            </div>
        </div>
    </div>

    <!-- Map -->
    <div class="map-section">
        <div class="map-header">
            <h3>Planta 0 · Vista de Plazas</h3>
            <div class="legend">
                <div class="legend-item"><div class="legend-dot" style="background:var(--primary)"></div> Libre</div>
                <div class="legend-item"><div class="legend-dot" style="background:var(--danger)"></div> Ocupado</div>
            </div>
        </div>

        <div class="parking-lot" id="parkingLot">
            <div style="text-align:center;color:var(--muted);font-size:13px;padding:30px 0">Cargando mapa...</div>
        </div>

        <div class="status-bar">
            <div class="stat">
                <div class="stat-dot free"></div>
                <div class="stat-num free" id="freeNum">0</div>
                <span style="font-size:11px;color:#666">disponibles</span>
            </div>
            <div class="stat">
                <div class="stat-dot occ"></div>
                <div class="stat-num occ" id="occNum">0</div>
                <span style="font-size:11px;color:#666">ocupados</span>
            </div>
        </div>

        <button class="btn-refresh" onclick="updateMap()">↺ &nbsp;REFRESCAR MAPA</button>
    </div>
</div>

<script>
    const API_URL = "https://pmv073dn7k.execute-api.us-east-1.amazonaws.com/prod/traffic";
    const chatWindow = document.getElementById("chatWindow");
    const loader = document.getElementById("loader");
    const parkingLot = document.getElementById("parkingLot");

    // Minimal inline car SVG
    function carSVG(color) {
        return `<svg class="car-svg" viewBox="0 0 54 28" fill="none" xmlns="http://www.w3.org/2000/svg">
            <rect x="2" y="10" width="50" height="14" rx="4" fill="${color}" opacity="0.55"/>
            <path d="M10 10 L15 3 H39 L44 10Z" fill="${color}" opacity="0.7"/>
            <rect x="16" y="4" width="22" height="6" rx="2" fill="rgba(255,255,255,0.25)"/>
            <circle cx="12" cy="24" r="4" fill="${color}" opacity="0.9"/>
            <circle cx="42" cy="24" r="4" fill="${color}" opacity="0.9"/>
            <circle cx="12" cy="24" r="2" fill="#0b1118"/>
            <circle cx="42" cy="24" r="2" fill="#0b1118"/>
            <rect x="2" y="11" width="6" height="4" rx="1" fill="rgba(255,220,0,0.7)"/>
            <rect x="46" y="11" width="6" height="4" rx="1" fill="rgba(255,80,80,0.7)"/>
        </svg>`;
    }

    // ── Mock data (activo mientras la API no esté configurada) ──────────────
    const USE_MOCK = false; // Cambia a false cuando la API esté lista

    const MOCK_ROWS = [
        { sensor_id: "A-1", status: "free",     event_time: "10:02" },
        { sensor_id: "A-2", status: "occupied", event_time: "09:47" },
        { sensor_id: "A-3", status: "free",     event_time: "10:05" },
        { sensor_id: "A-4", status: "occupied", event_time: "09:31" },
        { sensor_id: "A-5", status: "occupied", event_time: "09:15" },
        { sensor_id: "A-6", status: "free",     event_time: "10:08" },
        { sensor_id: "B-1", status: "occupied", event_time: "08:50" },
        { sensor_id: "B-2", status: "free",     event_time: "10:01" },
        { sensor_id: "B-3", status: "occupied", event_time: "09:22" },
        { sensor_id: "B-4", status: "free",     event_time: "09:58" },
        { sensor_id: "B-5", status: "free",     event_time: "10:10" },
        { sensor_id: "B-6", status: "occupied", event_time: "09:05" },
        { sensor_id: "C-1", status: "free",     event_time: "10:03" },
        { sensor_id: "C-2", status: "free",     event_time: "09:55" },
        { sensor_id: "C-3", status: "occupied", event_time: "08:42" },
        { sensor_id: "C-4", status: "occupied", event_time: "09:10" },
        { sensor_id: "C-5", status: "free",     event_time: "10:07" },
        { sensor_id: "C-6", status: "free",     event_time: "09:50" },
    ];

    async function callApi(params) {
        if (USE_MOCK) {
            // Simula un pequeño delay de red
            await new Promise(r => setTimeout(r, 400));
            if (params.mode === 'llm') {
                return { output: "[MODO DEMO] La API aún no está configurada. Estos son datos de ejemplo para visualizar el mapa." };
            }
            return { result: { rows: MOCK_ROWS } };
        }
        const url = new URL(API_URL);
        Object.entries(params).forEach(([k, v]) => url.searchParams.set(k, v));
        try {
            const response = await fetch(url, { method: "GET", headers: { "Accept": "application/json" } });
            if (!response.ok) throw new Error(`HTTP Error: ${response.status}`);
            const data = await response.json();
            return typeof data.body === 'string' ? JSON.parse(data.body) : data;
        } catch (err) {
            console.error("Error en API:", err);
            throw err;
        }
    }

    async function updateMap() {
        loader.style.display = "block";
        try {
            const data = await callApi({ mode: 'filters', limit: 20 });
            if (data.result && data.result.rows) {
                renderParkingLot(data.result.rows);
            } else {
                parkingLot.innerHTML = "<div style='text-align:center;color:var(--muted);padding:30px'>Sin datos recientes</div>";
            }
        } catch (e) {
            parkingLot.innerHTML = "<div style='text-align:center;color:var(--danger);padding:30px;font-size:13px'>Error al conectar con los sensores</div>";
        } finally {
            loader.style.display = "none";
        }
    }

    function renderParkingLot(rows) {
        // Latest status per sensor
        const latestMap = {};
        rows.forEach(row => { if (!latestMap[row.sensor_id]) latestMap[row.sensor_id] = row; });
        const sensors = Object.values(latestMap).sort((a, b) =>
            a.sensor_id.localeCompare(b.sensor_id, undefined, { numeric: true, sensitivity: 'base' })
        );

        parkingLot.innerHTML = "";
        let free = 0, occupied = 0;

        // Group sensors into rows of N spots per side
        const spotsPerRow = 3; // spots on each side of the lane
        const chunks = [];
        for (let i = 0; i < sensors.length; i += spotsPerRow * 2) {
            chunks.push(sensors.slice(i, i + spotsPerRow * 2));
        }

        // If we have few sensors, fall back to single-sided
        chunks.forEach((chunk, rowIdx) => {
            const left = chunk.slice(0, spotsPerRow);
            const right = chunk.slice(spotsPerRow);

            const rowEl = document.createElement("div");
            rowEl.className = "parking-row";

            const leftCol = document.createElement("div");
            leftCol.className = "spots-col left";

            const rightCol = document.createElement("div");
            rightCol.className = "spots-col right";

            const lane = document.createElement("div");
            lane.className = "lane";
            lane.textContent = String.fromCharCode(65 + rowIdx); // A, B, C…

            // Build spots helper
            function buildSpot(sensor) {
                const isFree = sensor.status.toLowerCase() === 'free' || sensor.status === '1';
                if (isFree) free++; else occupied++;
                const spotEl = document.createElement("div");
                spotEl.className = `spot ${isFree ? 'free' : 'occupied'}`;

                const carEl = document.createElement("div");
                carEl.className = "car-icon";
                carEl.innerHTML = carSVG("rgba(255,56,96,0.8)");

                const label = document.createElement("span");
                label.className = "spot-label";
                label.textContent = sensor.sensor_id;

                const time = document.createElement("span");
                time.className = "spot-time";
                time.textContent = sensor.event_time || "";

                spotEl.appendChild(carEl);
                spotEl.appendChild(label);
                spotEl.appendChild(time);
                spotEl.title = `${sensor.sensor_id} · ${isFree ? 'LIBRE' : 'OCUPADO'}${sensor.event_time ? ' · ' + sensor.event_time : ''}`;
                return spotEl;
            }

            left.forEach(s => leftCol.appendChild(buildSpot(s)));
            right.forEach(s => rightCol.appendChild(buildSpot(s)));

            rowEl.appendChild(leftCol);
            rowEl.appendChild(lane);
            rowEl.appendChild(rightCol);
            parkingLot.appendChild(rowEl);
        });

        // If all sensors fit on one side (e.g. < spotsPerRow*2), fallback already handled above
        // Handle case with no chunks
        if (chunks.length === 0) {
            parkingLot.innerHTML = "<div style='text-align:center;color:var(--muted);padding:30px'>Sin datos recientes</div>";
        }

        // Add entrance/exit indicator at bottom
        const entrance = document.createElement("div");
        entrance.style.cssText = "text-align:center;margin-top:10px;font-size:10px;color:rgba(255,255,255,0.2);font-family:'Rajdhani',sans-serif;letter-spacing:2px;";
        entrance.textContent = "▲  ENTRADA / SALIDA  ▲";
        parkingLot.appendChild(entrance);

        document.getElementById("freeNum").textContent = free;
        document.getElementById("occNum").textContent = occupied;
    }

    async function handleChat() {
        const text = document.getElementById("userInput").value.trim();
        if (!text) return;

        addMessage(text, 'user');
        document.getElementById("userInput").value = "";
        loader.style.display = "block";

        try {
            const data = await callApi({ mode: 'llm', prompt: text });
            addMessage(data.output || "No tengo respuesta en este momento.");
            if (data.result && data.result.rows) {
                renderParkingLot(data.result.rows);
            }
        } catch (e) {
            addMessage("Error en la conexión con el asistente.", 'ai');
        } finally {
            loader.style.display = "none";
        }
    }

    function addMessage(msg, type = 'ai') {
        const div = document.createElement("div");
        div.className = `msg msg-${type}`;
        div.textContent = msg;
        chatWindow.appendChild(div);
        chatWindow.scrollTop = chatWindow.scrollHeight;
    }

    document.getElementById("sendBtn").onclick = handleChat;
    document.getElementById("userInput").onkeypress = (e) => { if (e.key === 'Enter') handleChat(); };

    window.onload = () => {
        updateMap();
        if (USE_MOCK) {
            document.getElementById("apiStatus").textContent = "⬡ MODO DEMO — datos de ejemplo";
            document.getElementById("apiStatus").style.color = "#f5a623";
        } else {
            document.getElementById("apiStatus").textContent = "API Conectada";
            document.getElementById("apiStatus").style.color = "var(--primary)";
        }
    };
</script>

</body>
</html>